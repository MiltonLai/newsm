# 社区内容爬虫

## 综述
用于同步版面, 文章和作者

## 内容结构简介
* 数据主要包含: 分区, 版面, 文章, 作者
* 分区: 可以有父分区, 可以有子分区, 子版面
* 版面: 可以有父分区, 父版面, 可以有子版面, 有文章. 版面与分区是多对多的关系
* 文章: 隶属于一个版面, 文章ID自增, 在版面内唯一
* 作者: 以ID唯一, 不区分大小写
* 存在版面合并的情况, 合并后的版面, 包含与原版面一样的文章, 但是版面ID和文章ID都不一样.
* 存在受登录保护的版面. 未登录无法读取文章列表

## 任务规则
全局任务触发使用crontab, 每隔1小时执行一次, 需要执行的任务有:
* 启动会话, 登入
* 同步版面
  * 在config表记录更新时间, 当距离上次执行时间不超过24小时时, 跳过本任务
  * 检查是否有新增版面, 有则入库
* 同步文章
  * 自board表取出所有版面, 对每一个版面, 检查其t1, t2, t3值, 以及上次更新时间
    * t1为4小时内文章数量, 为0则跳过距上次更新不到4小时的版面
    * t2为16小时内文章数量, 为0则跳过距上次更新不到16小时的版面
    * t3为128小时内文章数量, 为0则跳过距上次更新不到128小时的版面
  * 更新以[版面ID].[文章ID]的格式作为记录ID, 当连续60个ID都已经存在时, 跳出更新
  * 更新作者, 表中不存在则入库, 表中存在则判断上次更新时间距现在是否超过24小时, 是则更新
  * 更新结束后, 更新board的post_count, t1, t2, t3值
* 同步作者
  * 分批更新, 按计划更新时间倒序, 每次5000条
  * ID已注销的用户, 记录更新时间, 计划更新时间设置为240小时之后
  * ID还存在的用户, 记录更新时间, 判断数值是否有变化
    * 有变化, 记录snapshot, 计划更新时间设置为72小时之后
    * 无变化, 计划更新时间设置为72小时之后
* 登出, 结束会话